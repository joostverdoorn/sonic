!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.Sonic=e()}}(function(){return function e(t,n,r){function u(i,a){if(!n[i]){if(!t[i]){var c="function"==typeof require&&require;if(!a&&c)return c(i,!0);if(o)return o(i,!0);var s=new Error("Cannot find module '"+i+"'");throw s.code="MODULE_NOT_FOUND",s}var l=n[i]={exports:{}};t[i][0].call(l.exports,function(e){var n=t[i][1][e];return u(n?n:e)},l,l.exports,e,t,n,r)}return n[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)u(r[i]);return u}({1:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r;n.factory=r,function(e){function t(e){return{get:function(t){return t in e?Promise.resolve(e[t]):Promise.reject(new Error)},prev:function(t){var n=null==t?e.length-1:t-1;return Promise.resolve(-1==n?null:n)},next:function(t){var n=null==t?0:t+1;return Promise.resolve(n==e.length?null:n)}}}function n(e){var t=Object.keys(e),n={"null":-1};return{get:function(t){return t in e?Promise.resolve(e[t]):Promise.reject(new Error)},prev:function(r){var u=null==r?t.length-1:n[r]-1;return n[t[u]]=u,null==r?Promise.resolve(t[t.length-1]):r in e?Promise.resolve(-1==u?null:t[u]):Promise.reject(new Error)},next:function(r){var u=n[r]+1;return n[t[u]]=u,null==r?Promise.resolve(t[0]):r in e?Promise.resolve(u==t.length?null:t[u]):Promise.reject(new Error)}}}e.fromArray=t,e.fromObject=n}(r||(n.factory=r={})),n["default"]=r},{}],2:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r;!function(e){function t(e){return e.toString()}function n(){return r++}var r=0;e.key=t,e.create=n}(r||(r={})),n["default"]=r,t.exports=n["default"]},{}],3:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=e("./key"),a=r(i),c=e("./observable"),s=e("./patch"),l=function(){function e(t,n){u(this,e),this._keyFn=n||a["default"].create,this._subject=new c.Subject,this._pseudoState=Object.keys(t).reduce(function(e,n,r,u){return e.get[n]=t[n],0==r&&(e.next["null"]=n),r==u.length-1&&(e.prev["null"]=n),e.prev[n]=null!=u[r-1]?u[r-1]:null,e.next[n]=null!=u[r+1]?u[r+1]:null,e},{get:Object.create(null),prev:Object.create(null),next:Object.create(null)})}return o(e,[{key:"add",value:function(e){var t=this._keyFn(e);if(t in this._pseudoState.get)return this.replace(t,e);var n=Object.create(this._pseudoState);n.get[t]=e;var r=n.prev["null"],u=null;return n.prev[u]=t,n.next[t]=u,n.prev[t]=r,n.next[r]=t,this._pseudoState=n,this._subject.onInvalidate([{op:s.Operation[s.Operation.add],key:t,value:Promise.resolve(e)}]),Promise.resolve()}},{key:"replace",value:function(e,t){if(!(e in this._pseudoState.get))return Promise.reject(new Error);var n=Object.create(this._pseudoState);return n.get[e]=t,this._pseudoState=n,this._subject.onInvalidate([{op:s.Operation[s.Operation.replace],key:e,value:Promise.resolve(t)}]),Promise.resolve()}},{key:"remove",value:function(t){if(!(t in this._pseudoState.get))return Promise.reject(new Error);var n=Object.create(this._pseudoState);n.get[t]=e.DELETED;var r=n.prev[t],u=n.next[t];return n.prev[u]=r,n.next[r]=u,this._pseudoState=n,this._subject.onInvalidate([{op:s.Operation[s.Operation.remove],key:t}]),Promise.resolve()}},{key:"observe",value:function(e){return this._subject.observe(e)}},{key:"state",get:function(){var t=this._pseudoState;return{get:function(n){return n in t.get&&t.get[n]!=e.DELETED?Promise.resolve(t.get[n]):Promise.reject(new Error)},prev:function(){var e=arguments.length<=0||void 0===arguments[0]?null:arguments[0];return e in t.prev?Promise.resolve(t.prev[e]):Promise.reject(new Error)},next:function(){var e=arguments.length<=0||void 0===arguments[0]?null:arguments[0];return e in t.next?Promise.resolve(t.next[e]):Promise.reject(new Error)}}}}]),e}();n["default"]=l,l.DELETED={},t.exports=n["default"]},{"./key":2,"./observable":5,"./patch":6}],4:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(n,"__esModule",{value:!0});var u,o=e("./state"),i=r(o),a=e("./observable"),c=e("./patch");n.List=u,function(e){function t(e,t){var n={state:e,subscribe:t.subscribe};return t.subscribe({onNext:function(e){n.state=i["default"].patch(n.state,e)}}),n}function n(e,n){var r=i["default"].map(e.state,n),u=a.Observable.map(e,function(e){return c.Patch.isSetPatch(e)?Promise.resolve(n(e.value,e.key)).then(function(t){return{operation:c.Patch.SET,key:e.key,value:t,before:e.before}}):e});return t(r,u)}function r(e,n){var r=i["default"].filter(e.state,n),u=a.Observable.map(e,function(e){return c.Patch.isSetPatch(e)?Promise.resolve(n(e.value,e.key)).then(function(t){return t?e:{operation:c.Patch.DELETE,key:e.key}}):e});return t(r,u)}function u(e,n){var r=i["default"].zoom(e.state,n),u=a.Observable.filter(e,function(e){return e.key===n});return t(r,u)}e.create=t,e.map=n,e.filter=r,e.zoom=u}(u||(n.List=u={})),n["default"]=u},{"./observable":5,"./patch":6,"./state":8}],5:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e){var t=!1;return{dispose:function(){t||(t=!0,e())}}}Object.defineProperty(n,"__esModule",{value:!0}),n.disposable=o;var i=e("./key"),a=r(i),c=function l(){var e=this;u(this,l),this._count=0,this.subscribe=function(t){var n=a["default"].create();return e._observers[n]=t,o(function(){return delete e._observers[n]})},this.onNext=function(t){return Promise.all(Object.keys(e._observers).map(function(n){return e._observers[n].onNext(t)})).then(function(){})},this._observers=Object.create(null)};n.Subject=c;var s;n.Observable=s,function(e){function t(e,t){var n=new c;return e.subscribe({onNext:function(e){return Promise.resolve(t(e)).then(n.onNext)}}),{subscribe:n.subscribe}}function n(e,t){var n=new c;return e.subscribe({onNext:function(e){return Promise.resolve(t(e)).then(function(t){return t?n.onNext(e):void 0})}}),{subscribe:n.subscribe}}e.map=t,e.filter=n}(s||(n.Observable=s={}))},{"./key":2}],6:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r;n.Patch=r,function(e){function t(t){return t.operation===e.SET}function n(t){return t.operation===e.DELETE}e.SET="set",e.DELETE="delete",e.isSetPatch=t,e.isDeletePatch=n}(r||(n.Patch=r={})),n["default"]=r},{}],7:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function u(e){}Object.defineProperty(n,"__esModule",{value:!0}),n.Sonic=u;var u,o=e("./patch"),i=r(o),a=e("./state"),c=r(a),s=e("./state_iterator"),l=r(s),f=e("./list"),v=r(f),d=e("./keyed_list"),h=r(d),p=e("./factory"),b=r(p),g=e("./observable");n.Sonic=u,function(e){e.Patch=i["default"],e.State=c["default"],e.StateIterator=l["default"],e.List=v["default"],e.factory=b["default"],e.KeyedList=h["default"],e.Subject=g.Subject}(u||(n.Sonic=n.Sonic=u={})),t.exports=u,n["default"]=u},{"./factory":1,"./keyed_list":3,"./list":4,"./observable":5,"./patch":6,"./state":8,"./state_iterator":9}],8:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(n,"__esModule",{value:!0});var u,o=e("./state_iterator"),i=r(o),a=e("./patch"),c=r(a);n.State=u,function(e){function t(e,t){var n=t.get,r=t.prev,u=t.next,o=Object.create(e);return n&&(o.get=n),r&&(o.prev=r),u&&(o.next=u),o}function n(e,n){var r=e;return c["default"].isSetPatch(n)&&(r=t(r,u(r,n.key,n.value,n.before))),c["default"].isDeletePatch(n)&&(r=t(r,o(r,n.key))),r}function r(e,t){return t.reduce(function(e,t){return n(e,t)},e)}function u(e,n,r,u){var o={get:function(t){return t===n?Promise.resolve(r):e.get(t)}};return void 0!==u&&(o.prev=function(){var t=arguments.length<=0||void 0===arguments[0]?null:arguments[0];return t===u?Promise.resolve(n):t==n?e.prev(u):e.prev(t)},o.next=function(){var t=arguments.length<=0||void 0===arguments[0]?null:arguments[0];return t===n?Promise.resolve(u):e.next(t).then(function(e){return e==u?n:e})}),t(e,o)}function o(n,r){return t(n,{get:function(t){return t!==r?n.get(t):e.NOT_FOUND},prev:function(){var e=arguments.length<=0||void 0===arguments[0]?null:arguments[0];return n.prev(e).then(function(e){return e===r?n.prev(e):e})},next:function(){var e=arguments.length<=0||void 0===arguments[0]?null:arguments[0];return n.next(e).then(function(e){return e===r?n.next(e):e})}})}function a(e){return t(e,{prev:e.next,next:e.prev})}function s(e,n){return t(e,{get:function(t){return e.get(t).then(function(e){return n(e,t)})}})}function l(n,r){return t(n,{get:function(t){return n.get(t).then(function(t){return r(t)?t:e.NOT_FOUND})},prev:function(t){return i["default"].findKey(e.reverse(n),r,[t,null])},next:function(e){return i["default"].findKey(n,r,[e,null])}})}function f(n,r){var u=function(t){return null==t?Promise.resolve(r):t===r?Promise.resolve(null):e.NOT_FOUND};return t(n,{get:function(t){return t===r?n.get(r):e.NOT_FOUND},prev:u,next:u})}e.extend=t,e.patch=n,e.patches=r,e.set=u,e.del=o,e.reverse=a,e.map=s,e.filter=l,e.zoom=f}(u||(n.State=u={})),Object.defineProperty(u,"NOT_FOUND",{get:function(){return Promise.reject("No entry at the specified key")}}),n["default"]=u},{"./patch":6,"./state_iterator":9}],9:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var o=e("./state"),i=r(o),a=function c(e){var t=this,n=arguments.length<=1||void 0===arguments[1]?[null,null]:arguments[1];u(this,c),this.get=function(){return t.state.get(t.current)},this.prev=function(){return t.state.prev(null==t.current?t.range[1]:t.current).then(function(e){return e==t.range[0]?t.current=null:t.current=e})},this.next=function(){return t.state.next(null==t.current?t.range[0]:t.current).then(function(e){return e==t.range[1]?t.current=null:t.current=e})},this.state=e,this.range=n};n.StateIterator=a,function(e){function t(e){var t=arguments.length<=1||void 0===arguments[1]?[null,null]:arguments[1];return e.next(t[0]).then(e.get)}function n(e){var t=arguments.length<=1||void 0===arguments[1]?[null,null]:arguments[1];return e.prev(t[1]).then(e.get)}function r(t,n,r){function u(){return o.next().then(function(e){return null==e||o.get().then(function(t){return n(t,e)}).then(function(e){return e?u():!1})})}var o=new e(t,r);return u()}function u(e,t,n){return r(e,function(e,n){return Promise.resolve(t(e,n)).then(function(e){return!e})},n).then(function(e){return!e})}function o(e,t,n){return r(e,function(e,n){return Promise.resolve(t(e,n)).then(function(){return!0})},n).then(function(){})}function a(e,t,n,r){return o(e,function(e,r){return Promise.resolve(t(n,e,r)).then(function(e){n=e})},r).then(function(){return n})}function c(e,t){return a(e,function(e,t){return e.push(t),e},[],t)}function s(e,t){return a(e,function(e,t,n){return e[n]=t,e},Object.create(null),t)}function l(e,t,n){var r;return u(e,function(e,n){return Promise.resolve(t(e,n)).then(function(e){return e?(r=n,!0):!1})},n).then(function(e){return e?r:null})}function f(e,t,n){return l(e,t,n).then(e.get)}function v(e,t,n){return l(e,function(e){return e===t},n)}function d(e,t,n){var r=-1;return u(e,function(e,n){return r++,t==e},n).then(function(e){return e?r:void i["default"].NOT_FOUND})}function h(e,t,n){return l(e,function(){return 0===t--},n)}function p(e,t,n){return h(e,t,n).then(e.get)}function b(e,t,n){return u(e,function(e){return e===t},n)}e.first=t,e.last=n,e.every=r,e.some=u,e.forEach=o,e.reduce=a,e.toArray=c,e.toObject=s,e.findKey=l,e.find=f,e.keyOf=v,e.indexOf=d,e.keyAt=h,e.at=p,e.contains=b}(a||(n.StateIterator=a={})),n["default"]=a},{"./state":8}]},{},[7])(7)});