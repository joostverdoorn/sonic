!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.Sonic=e()}}(function(){return function e(t,n,r){function u(i,a){if(!n[i]){if(!t[i]){var c="function"==typeof require&&require;if(!a&&c)return c(i,!0);if(o)return o(i,!0);var f=new Error("Cannot find module '"+i+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[i]={exports:{}};t[i][0].call(l.exports,function(e){var n=t[i][1][e];return u(n?n:e)},l,l.exports,e,t,n,r)}return n[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)u(r[i]);return u}({1:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)}Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=function(e,t,n){for(var r=!0;r;){var u=e,o=t,i=n;a=f=c=void 0,r=!1,null===u&&(u=Function.prototype);var a=Object.getOwnPropertyDescriptor(u,o);if(void 0!==a){if("value"in a)return a.value;var c=a.get;return void 0===c?void 0:c.call(i)}var f=Object.getPrototypeOf(u);if(null===f)return void 0;e=f,t=o,n=i,r=!0}},c=e("./list"),f=r(c),l=e("./patch"),s=function(e){function t(e){u(this,t),a(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this._list=e,this._get=Object.create(null),this._prev=Object.create(null),this._next=Object.create(null),e.observe(this)}return o(t,e),i(t,[{key:"onInvalidate",value:function(e){var n=this;return this._get=Object.create(this._get),this._prev=Object.create(this._prev),this._next=Object.create(this._next),e.forEach(function(e){var r=e.key,u=e.value;switch(e.type){case l.Operation[l.Operation.add]:n._get[r]=u;var o=n._prev["null"],i=null;n._prev[i]=r,n._next[r]=i,n._prev[r]=o,n._next[o]=r;break;case l.Operation[l.Operation.remove]:n._get[r]=t.DELETED;var o=n._prev[r],i=n._next[r];n._prev[i]=o,n._next[o]=i;break;case l.Operation[l.Operation.replace]:n._get[r]=u}}),this._subject.notify(e)}},{key:"state",get:function(){var e=this._get,n=this._prev,r=this._next,u=this._list.state,o={get:function(n){return e[n]==t.DELETED?Promise.reject(new Error):null==e[n]?u.get(n).then(function(t){return e[n]=t}):Promise.resolve(e[n])},prev:function(e){return null==n[e]?u.prev(e).then(function(t){return r[t]=e,n[e]=t}):Promise.resolve(n[e])},next:function(e){return null==r[e]?u.next(e).then(function(t){return n[t]=e,r[e]=t}):Promise.resolve(r[e])}};return o}}]),t}(f["default"]);n.Cache=s,s.DELETED={},n["default"]=s},{"./list":4,"./patch":6}],2:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r;n.factory=r,function(e){function t(e){return{get:function(t){return t in e?Promise.resolve(e[t]):Promise.reject(new Error)},prev:function(t){var n=null==t?e.length-1:t-1;return Promise.resolve(-1==n?null:n)},next:function(t){var n=null==t?0:t+1;return Promise.resolve(n==e.length?null:n)}}}function n(e){var t=Object.keys(e),n={"null":-1};return{get:function(t){return t in e?Promise.resolve(e[t]):Promise.reject(new Error)},prev:function(r){var u=null==r?t.length-1:n[r]-1;return n[t[u]]=u,null==r?Promise.resolve(t[t.length-1]):r in e?Promise.resolve(-1==u?null:t[u]):Promise.reject(new Error)},next:function(r){var u=n[r]+1;return n[t[u]]=u,null==r?Promise.resolve(t[0]):r in e?Promise.resolve(u==t.length?null:t[u]):Promise.reject(new Error)}}}e.fromArray=t,e.fromObject=n}(r||(n.factory=r={})),n["default"]=r},{}],3:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r;!function(e){function t(e){return e.toString()}function n(){return r++}var r=0;e.key=t,e.create=n}(r||(r={})),n["default"]=r,t.exports=n["default"]},{}],4:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=e("./state"),a=r(i),c=e("./state_iterator"),f=r(c),l=e("./observable"),s=e("./patch"),v=function(){function e(t){var n=this;u(this,e),Object.keys(f["default"]).forEach(function(e){return n[e]=function(){for(var t=arguments.length,r=Array(t),u=0;t>u;u++)r[u]=arguments[u];return f["default"][e].apply(f["default"],[n.state].concat(r))}}),Object.keys(e).forEach(function(t){return n[t]=function(){for(var r=arguments.length,u=Array(r),o=0;r>o;o++)u[o]=arguments[o];return e[t].apply(e,[n].concat(u))}}),null!=t&&(this.state=t),this._subject=new l.Subject}return o(e,[{key:"add",value:function(e,t){return this.onInvalidate([{type:s.Operation[s.Operation.add],key:e,value:t}])}},{key:"replace",value:function(e,t){var n=this;return this.state.get(e).then(function(r){return n.onInvalidate([{type:s.Operation[s.Operation.replace],key:e,value:t,oldValue:r}])})}},{key:"remove",value:function(e){return this.onInvalidate([{type:s.Operation[s.Operation.remove],key:e}])}},{key:"observe",value:function(e){return this._subject.observe(e)}},{key:"onInvalidate",value:function(e){var t=this;return console.log("Number of events received:",e.length),e.forEach(function(e){switch(e.type){case s.Operation[s.Operation.add]:t.state=a["default"].add(t.state,e.key,e.value);break;case s.Operation[s.Operation.remove]:t.state=a["default"].remove(t.state,e.key);break;case s.Operation[s.Operation.replace]:t.state=a["default"].replace(t.state,e.key,e.value)}}),Promise.resolve(this._subject.notify(e))}},{key:"get",get:function(){return this.state.get}},{key:"prev",get:function(){return this.state.prev}},{key:"next",get:function(){return this.state.next}}]),e}();n.List=v,function(e){function t(t){var n=t.state,r=new e(a["default"].reverse(n));return t.observe({onInvalidate:function(e){return Promise.all(e.map(function(e){return s.Patch.reverse(e,n)})).then(function(e){return r.onInvalidate(e)})}}),r}function n(t,n){var r=new e(a["default"].map(t.state,n));return t.observe({onInvalidate:function(e){return Promise.all(e.map(function(e){return s.Patch.map(e,n)})).then(function(e){return r.onInvalidate(e)})}}),r}function r(t,n){var r=t.state,u=new e(a["default"].filter(t.state,n));return t.observe({onInvalidate:function(e){return Promise.all(e.map(function(e){return s.Patch.filter(e,n,r)})).then(function(e){return e.filter(function(e){return null!=e})}).then(function(e){return e.length?u.onInvalidate(e):void 0})}}),u}e.reverse=t,e.map=n,e.filter=r}(v||(n.List=v={})),n["default"]=v},{"./observable":5,"./patch":6,"./state":7,"./state_iterator":8}],5:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var o=e("./key"),i=r(o),a=function c(){var e=this;u(this,c),this.observe=function(t){var n=i["default"].create();return e._observers[n]=t,{unsubscribe:function(){delete e._observers[n]}}},this.notify=function(t){return Promise.all(Object.keys(e._observers).map(function(n){return e._observers[n].onInvalidate(t)})).then(function(){})},this._observers=Object.create(null)};n.Subject=a},{"./key":3}],6:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r;n.Operation=r,function(e){e[e.add=0]="add",e[e.remove=1]="remove",e[e.replace=2]="replace"}(r||(n.Operation=r={}));var u;n.Patch=u,function(e){function t(e,t){return Promise.resolve(e)}function n(e,t){return Promise.resolve(t(e.value,e.key)).then(function(t){return{type:e.type,key:e.key,value:t}})}function u(e,t,n){if(e.type==r[r.add]&&t(e.value,e.key))return Promise.resolve(e);if(e.type==r[r.replace]){if(t(e.oldValue,e.key)&&!t(e.value,e.key))return Promise.resolve({type:r[r.remove],key:e.key});if(!t(e.oldValue,e.key)&&t(e.value,e.key))return Promise.resolve({type:r[r.add],key:e.key,value:e.value});if(t(e.oldValue,e.key)&&t(e.value,e.key))return Promise.resolve(e)}return e.type==r[r.remove]?n.get(e.key).then(function(n){return t(n,e.key)?e:null}):null}e.reverse=t,e.map=n,e.filter=u}(u||(n.Patch=u={})),n["default"]=u},{}],7:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(n,"__esModule",{value:!0});var u,o=e("./state_iterator"),i=r(o);n.State=u,function(e){function t(t,n,r){var u=Object.create(t);return u.prev=function(e){return null==e?Promise.resolve(n):t.prev(e==n?null:e)},u.next=function(e){return e==n?Promise.resolve(null):t.next(e).then(function(e){return null==e?n:e})},e.replace(u,n,r)}function n(e,t,n){var r=Object.create(e);return r.get=function(r){return r==t?Promise.resolve(n):e.get(r)},r}function r(e,t){var n=Object.create(e);return n.get=function(n){return n==t?Promise.reject(new Error):e.get(n)},n.prev=function(n){return e.prev(n).then(function(n){return n==t?e.prev(n):n})},n.next=function(n){return e.next(n).then(function(n){return n==t?e.next(n):n})},n}function u(e){var t=Object.create(e);return t.prev=function(t){return e.next(t)},t.next=function(t){return e.prev(t)},t}function o(e,t){var n=Object.create(e);return n.get=function(n){return e.get(n).then(function(e){return t(e,n)})},n}function a(t,n){var r=Object.create(t);return r.get=function(e){return t.get(e).then(function(e){if(n(e))return e;throw new Error})},r.prev=function(r){return i["default"].findKey(e.reverse(t),n,[r,null])},r.next=function(e){return i["default"].findKey(t,n,[e,null])},r}e.add=t,e.replace=n,e.remove=r,e.reverse=u,e.map=o,e.filter=a}(u||(n.State=u={})),n["default"]=u},{"./state_iterator":8}],8:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var u=function o(e){var t=this,n=void 0===arguments[1]?[null,null]:arguments[1];r(this,o),this.get=function(){return t.state.get(t.current)},this.prev=function(){return t.state.prev(null==t.current?t.range[1]:t.current).then(function(e){return t.current=e==t.range[0]?null:e})},this.next=function(){return t.state.next(null==t.current?t.range[0]:t.current).then(function(e){return t.current=e==t.range[1]?null:e})},this.state=e,this.range=n,this.current=n[0]};n.StateIterator=u,function(e){function t(e){var t=void 0===arguments[1]?[null,null]:arguments[1];return e.next(t[0]).then(e.get)}function n(e){var t=void 0===arguments[1]?[null,null]:arguments[1];return e.prev(t[1]).then(e.get)}function r(t,n,r){function u(){return o.next().then(function(e){return null==e||o.get().then(function(t){return n(t,e)}).then(function(e){return e?u().then(function(){return!0}):!1})})}var o=new e(t,r);return u()}function u(e,t,n){var u=!1;return r(e,function(e,n){return Promise.resolve(t(e,n)).then(function(e){return u=!!e,!u})},n).then(function(e){return u})}function o(e,t,n){return r(e,function(e,n){return Promise.resolve(t(e,n)).then(function(){return!0})},n).then(function(){})}function i(e,t,n,r){return o(e,function(e,r){return Promise.resolve(t(n,e,r)).then(function(e){n=e})},r).then(function(){return n})}function a(e,t){return i(e,function(e,t){return e.push(t),e},[],t)}function c(e,t){return i(e,function(e,t,n){return e[n]=t,e},Object.create(null),t)}function f(e,t,n){var r;return u(e,function(e,n){return Promise.resolve(t(e,n)).then(function(e){return e?!!(r=n)||!0:!1})},n).then(function(e){return e?r:null})}function l(e,t,n){return f(e,t,n).then(e.get)}function s(e,t,n){return f(e,function(e){return e===t},n)}function v(e,t,n){var r=-1;return u(e,function(e,n){return r++,t==e},n).then(function(e){if(e)return r;throw new Error})}function p(e,t,n){return f(e,function(){return 0===t--},n)}function d(e,t,n){return p(e,t,n).then(e.get)}function h(e,t,n){return u(e,function(e){return e===t},n)}e.first=t,e.last=n,e.every=r,e.some=u,e.forEach=o,e.reduce=i,e.toArray=a,e.toObject=c,e.findKey=f,e.find=l,e.keyOf=s,e.indexOf=v,e.keyAt=p,e.at=d,e.contains=h}(u||(n.StateIterator=u={})),n["default"]=u},{}],9:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function u(e){return e instanceof Array?new l["default"](d["default"].fromArray(e)):e instanceof Object?new l["default"](d["default"].fromObject(e)):void 0}Object.defineProperty(n,"__esModule",{value:!0}),n.Sonic=u;var u,o=e("./state"),i=r(o),a=e("./state_iterator"),c=r(a),f=e("./list"),l=r(f),s=e("./cache"),v=r(s),p=e("./factory"),d=r(p);n.Sonic=u,function(e){e.State=i["default"],e.StateIterator=c["default"],e.List=l["default"],e.Cache=v["default"],e.factory=d["default"]}(u||(n.Sonic=n.Sonic=u={})),t.exports=u,n["default"]=u},{"./cache":1,"./factory":2,"./list":4,"./state":7,"./state_iterator":8}]},{},[9])(9)});